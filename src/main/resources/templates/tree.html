<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml" lang="ru">
<head>
    <meta charset="utf-8" />
    <title>Генеалогическое древо — Cytoscape</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- cytoscape + dagre -->
    <script src="https://unpkg.com/cytoscape@3.24.0/dist/cytoscape.min.js"></script>
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.3.2/cytoscape-dagre.js"></script>

    <style>
        body { background: #FAF6F0; color: #3B2F2F; font-family: "Segoe UI", sans-serif; }
        #cy { width: 100%; height: 78vh; background: #fff; border-radius: 10px; border:1px solid #D9825B; }
        .legend { margin-top: 8px; }

        /* node card styling (Cytoscape uses SVG/text — styling here is for nodes via style section) */
    </style>
</head>
<body>

<div th:replace="~{fragments/navbar :: navbar}" sec:authorize="isAuthenticated()"></div>

<div class="container mt-4">
    <h2 class="text-center mb-3">Генеалогическое древо (Cytoscape)</h2>

    <div id="cy" class="shadow-sm"></div>

    <div class="legend text-center small">
        <span style="display:inline-block; padding:6px 10px; border-radius:6px; border:1px solid #7C8B60; background:#FAF6F0; margin-right:8px;">Мужчина</span>
        <span style="display:inline-block; padding:6px 10px; border-radius:6px; border:1px solid #D9825B; background:#fff;">Женщина</span>
    </div>
</div>

<script>
    // регистрируем расширение
    cytoscape.use( cytoscapeDagre );

    async function buildFamily() {
      const container = document.getElementById('cy');

      // загрузка данных с бэкенда
      const res = await fetch('/api/tree');
      if (!res.ok) {
        container.innerHTML = "<div class='text-center text-danger p-3'>Ошибка загрузки /api/tree</div>";
        console.error("API error", res.status);
        return;
      }
      const data = await res.json();
      console.log("Исходные данные:", data);

      // индекс по id
      const byId = Object.fromEntries(data.map(p => [p.id, p]));

      // подготовка элементов cytoscape
      const elements = [];

      // узлы
      data.forEach(p => {
        const name = `${p.firstName || ''} ${p.lastName || ''}`.trim();
        const birth = p.birthDate || '';
        // label: две строки — имя и дата (используем \n)
        const label = birth ? `${name}\n${birth}` : name;

        elements.push({
          data: { id: p.id, label, firstName: p.firstName, lastName: p.lastName, birth: p.birthDate, gender: p.gender }
        });
      });

      // ребра: отец->ребенок и мать->ребенок
      data.forEach(p => {
        if (p.fatherId && byId[p.fatherId]) {
          elements.push({ data: { id: `e_f_${p.fatherId}_${p.id}`, source: p.fatherId, target: p.id, relation: 'father' }});
        }
        if (p.motherId && byId[p.motherId]) {
          elements.push({ data: { id: `e_m_${p.motherId}_${p.id}`, source: p.motherId, target: p.id, relation: 'mother' }});
        }
        // spouse link (undirected visual link) — add single edge between spouses
        if (p.spouseId && byId[p.spouseId]) {
          // add only once: ensure id smaller-first to avoid duplicates
          const a = p.id, b = p.spouseId;
          const edgeId = a < b ? `e_s_${a}_${b}` : `e_s_${b}_${a}`;
          if (!elements.some(el => el.data && el.data.id === edgeId)) {
            elements.push({ data: { id: edgeId, source: a, target: b, relation: 'spouse' }});
          }
        }
      });

      // init cy
      const cy = cytoscape({
        container: container,
        elements: elements,
        style: [
          {
            selector: 'node',
            style: {
              'label': 'data(label)',
              'text-wrap': 'wrap',
              'text-valign': 'center',
              'text-halign': 'center',
              'font-size': 12,
              'background-color': '#fff',
              'border-width': 2,
              'border-color': '#7C8B60',
              'width': '160px',
              'height': '60px',
              'shape': 'roundrectangle',
              'padding': '6px',
              'text-margin-y': 0,
              'color': '#3B2F2F',
              'text-wrap': 'wrap'
            }
          },
          {
            selector: 'node[gender = "MALE"]',
            style: {
              'border-color': '#7C8B60'
            }
          },
          {
            selector: 'node[gender = "FEMALE"]',
            style: {
              'border-color': '#D9825B'
            }
          },
          {
            selector: 'edge[relation = "father"]',
            style: {
              'curve-style':'bezier',
              'line-color': '#7C8B60',
              'target-arrow-shape': 'none',
              'width': 2
            }
          },
          {
            selector: 'edge[relation = "mother"]',
            style: {
              'curve-style':'bezier',
              'line-style': 'dashed',
              'line-color': '#7C8B60',
              'target-arrow-shape': 'none',
              'width': 2
            }
          },
          {
            selector: 'edge[relation = "spouse"]',
            style: {
              'curve-style': 'straight',
              'line-style': 'dotted',
              'line-color': '#4A5C6A',
              'width': 2,
              'target-arrow-shape': 'none'
            }
          },
          {
            selector: '.highlighted',
            style: {
              'background-color': '#ffeb99',
              'border-color': '#D9825B',
              'transition-property': 'border-color, background-color',
              'transition-duration': '0.2s'
            }
          }
        ],
        layout: {
          name: 'dagre',
          rankDir: 'TB',   // TB = top->bottom
          nodeSep: 50,
          edgeSep: 10,
          rankSep: 100,
          rankDir: 'TB'
        },
        userZoomingEnabled: true,
        boxSelectionEnabled: false,
        autoungrabify: false
      });

      // set gender data attributes so selectors 'node[gender=..]' work
      data.forEach(p => {
        const n = cy.getElementById(p.id);
        if (n) n.data('gender', p.gender);
      });

      // center & fit
      cy.fit(40);

      // click handler
      cy.on('tap', 'node', function(evt){
        const n = evt.target;
        const info = `${n.data('label')}\nПол: ${n.data('gender') || '—'}`;
        alert(info);
      });

      // tooltip / hover highlight for children / parents
      cy.on('mouseover', 'node', function(evt){
        const n = evt.target;
        n.addClass('highlighted');
      });
      cy.on('mouseout', 'node', function(evt){
        const n = evt.target;
        n.removeClass('highlighted');
      });

    } // buildFamily

    buildFamily().catch(err => {
      console.error(err);
      document.getElementById('cy').innerHTML = "<div class='p-3 text-danger'>Ошибка: " + err.message + "</div>";
    });
</script>

</body>
</html>
